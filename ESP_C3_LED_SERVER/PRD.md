# Project Requirements Document: ESP32-C3 LED Controller Server

## 1. Overview

This document outlines the requirements for an ESP32-C3 based server designed to control multiple LED strips. The server will act as a hub, receiving triggers from remote motion sensor devices and activating corresponding LED strips with configurable brightness and timing. It will also host a web interface for manual control and configuration, and provide an API for integration with a central server.

## 2. Core Functionality

-   Receives motion detection events from remote sensor boards via an HTTP endpoint.
-   Controls multiple single-color LED strips via GPIOs using PWM for brightness.
-   Implements smooth fade-in/fade-out effects for all LED state changes.
-   Provides a web-based user interface for manual control and settings configuration.
-   Supports grouping of multiple LED strips into controllable "Items" (e.g., "Kitchen Countertop").
-   Features two primary control modes: Automatic (sensor-triggered) and Manual (user override).
-   Hosts an API for status reporting and control by a central server.
-   Persists all configuration (Wi-Fi, device settings, brightness levels) across reboots.
-   Provides visual status feedback via an onboard LED.

## 3. System & Hardware Definitions

### 3.1. Items
-   An "Item" is the primary controllable entity in the system.
-   It is a logical grouping defined in the code, consisting of a user-friendly name (e.g., "Kitchen Countertop"), one or more associated LED strips (identified by their GPIO pins), and one or more associated motion sensors (identified by their names).
-   All actions (on/off, brightness change) are applied to all LED strips within an Item simultaneously.

### 3.2. Motion Sensors
-   The server expects to receive motion events from external sensor boards (as described in `MOTION_SENSOR_PRD.md`).
-   These sensors will send an `HTTP POST` to the server's `/api/motionSensor` endpoint.
-   The payload will be a JSON object: `{ "sensor": "sensor_name", "state": 1 }` for motion start and `{ "sensor": "sensor_name", "state": 0 }` for motion end.

### 3.3. LED Strips
-   Controlled via dedicated GPIO pins connected to MOSFETs.
-   Brightness is managed using PWM signals generated by the ESP32-C3's `LEDC` peripheral.
-   Initial brightness for all Items upon first boot is 50%.

### 3.4. Onboard Status LED
-   An LED on `GPIO 8` (active-low: HIGH logic level = off, LOW = on) indicates the server's status.
-   **Fast Blink:** Not configured (in Provisioning Mode).
-   **Slow Blink (1s interval):** Connecting to Wi-Fi or Wi-Fi connection lost.
-   **Solid Off:** Normal operation (connected to Wi-Fi).

## 4. Operational Modes

### 4.1. Provisioning Mode (First Time Setup)
-   **Activation:** Enters this mode on first boot if Wi-Fi credentials are not found in NVS.
-   **Network:** Creates an open Wi-Fi Access Point with the SSID `led-controller-setup`.
-   **Configuration Portal:** Serves a web page to configure:
    1.  **Server Name:** A custom name for the device (e.g., "Room 1").
    2.  **Wi-Fi SSID & Password**.
-   Sensor/LED mappings are hard-coded and not configurable here. On submission, credentials are saved to NVS and the device reboots.

### 4.2. Normal Mode
-   **Connection:** Connects to the configured Wi-Fi network.
-   **mDNS:** Discoverable on the local network at `http://<Server-Name>.local/`.
-   **Functionality:** All automation, manual control, and API services are active.

### 4.3. Wi-Fi Disconnected Mode
-   **Activation:** Enters this mode if the Wi-Fi connection is lost during normal operation.
-   **Behavior:**
    -   All automation and web services are suspended.
    -   All connected LED strips are set to a fixed 10% brightness.
    -   The Onboard Status LED blinks slowly, indicating a reconnection attempt.
-   The device will continuously try to reconnect to Wi-Fi and will resume Normal Mode upon success.

## 5. Control Logic

### 5.1. Automatic Control
-   When a motion event (`state: 1`) is received from a sensor, the corresponding Item's LEDs fade in to their configured brightness.
-   The LEDs remain on for a configurable duration (**Automation Timer**).
-   If a new motion event for the same Item is received while the timer is active, the timer resets.
-   When the timer expires, the LEDs fade out.

### 5.2. Manual Control

- Users can turn an Item on/off via the web UI or API.

- **Manual ON:**

    - Activating an Item manually (turning it ON) sets it to **Manual Mode**.

    - In Manual Mode, the Item ignores all motion sensor events and its Automation Timer.

    - A **Global Manual Override Timer** starts (or resets) whenever any Item is turned ON manually.

- **Manual OFF:**

    - Turning an Item OFF manually sets it to **Automatic Mode** immediately and fades it out.

    - Since it is in Automatic Mode, a new motion trigger from a sensor will turn the Item back ON.

- **Global Manual Override Timer Expiration:**

    - When this timer expires, all Items currently in Manual Mode revert to Automatic Mode and fade out. This prevents lights from being left on indefinitely.

## 6. Web Interface (UI)

### 6.1. Main Page (`/`)
-   Displays a list of all configured "Items".
-   Each item in the list shows its name and has an on/off toggle switch for manual control.
-   Provides a link/button to navigate to the "Advanced Settings" page.

### 6.2. Advanced Settings Page (`/settings`)
-   Provides a "Back" button to return to the Main Page.
-   Allows configuration of global settings:
    -   **Automation Timer:** Duration (in seconds) for how long lights stay on after motion.
    -   **Manual Override Timer:** Duration (in hours) before manual control is disabled.
    -   **Fade Duration:** Time (in seconds) for fade-in/out transitions. (Default: 1s)
-   Displays a list of all "Items", each with a slider to configure its brightness level (0-100%).
-   All settings on this page are persisted in NVS.

## 7. Network Services (API)

-   **Sensor Input:**
    -   `POST /api/motionSensor`: Endpoint for receiving motion data from sensor boards.
-   **Central Server Integration:**
    -   `GET /api/status`: Returns a JSON object detailing the current state of all Items (name, on/off status, brightness, manual override active).
    -   `POST /api/control`: Allows a remote server to control an Item.
        -   **Payload:** `{ "item": "item_name", "state": "on/off", "brightness": percentage }` (brightness is optional).

## 8. Persistence (NVS)

The following settings will be stored in Non-Volatile Storage:
-   Server Name
-   Wi-Fi SSID & Password
-   Brightness level for each Item (Default: 50%)
-   Global Automation Timer value
-   Global Manual Override Timer value
-   Global Fade Duration value

## 9. Boot & Initial State Sequence

1.  Device powers on.
2.  If Wi-Fi is configured, it attempts to connect. During this time, all LED strips blink at 20% brightness (1s interval) and the status LED blinks slowly.
3.  Upon successful Wi-Fi connection, all LED strips turn on solid to 20% brightness for 10 seconds.
4.  After 10 seconds, all LED strips fade out and the system enters Normal Mode, ready for automatic or manual control.

## 10. Technical Feasibility Note

-   **PWM Control:** The use of the ESP32-C3's `LEDC` (LED Control) peripheral is confirmed as feasible for this project. It provides 6 independent, high-speed hardware PWM channels that can be routed to most GPIO pins, allowing for efficient and smooth brightness control and fading effects for multiple LED strips.
